<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrador</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Valentine Cocina</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="#" id="btnGestionUsuarios">Gestionar Usuarios</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="btnGestionProductos">Gestionar Productos</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="btnGestionMateriaPrima">Gestionar Materia Prima</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html" id="btnLogout">Cerrar Sesión</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Bienvenido, Administrador</h2>

        <!-- Gráficas -->
        <div class="row">
            <div class="col-md-6">
                <h4>Ingresos por Sector</h4>
                <canvas id="ingresosPorSector"></canvas>
            </div>
            <div class="col-md-6">
                <h4>Rendimiento por Sector</h4>
                <canvas id="rendimientoPorSector"></canvas>
            </div>
        </div>

        <!-- Tabla de Usuarios -->
        <h4 class="mt-4">Usuarios Registrados</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Sector</th>
                    <th>Último Ingreso</th>
                    <th>Último Egreso</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaUsuarios"></tbody>
        </table>

        <!-- Tabla de Ventas -->
        <h4 class="mt-4">Ventas Globales</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Unidad</th>
                    <th>Sector</th>
                    <th>Empleado</th>
                </tr>
            </thead>
            <tbody id="tablaVentasGlobales"></tbody>
        </table>

        <!-- Tabla de Materia Prima -->
        <h4 class="mt-4">Materia Prima</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Cantidad Disponible</th>
                    <th>Unidad</th>
                    <th>Sector</th>
                </tr>
            </thead>
            <tbody id="tablaMateriaPrima"></tbody>
        </table>
    </div>
<h4 class="mt-4">Productos</h4>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Sector</th>
            <th>Precio Compra</th>
            <th>Precio Venta</th>
            <th>Fecha Creación</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody id="tablaProductos"></tbody>
</table>

    <script>
        // Funcionalidad de logout
        document.getElementById('btnLogout').addEventListener('click', async () => {
            await fetch('http://localhost:3000/auth/logout', { method: 'POST' });
        });

        // Gráfica de ingresos por sector
        const ingresosCtx = document.getElementById('ingresosPorSector').getContext('2d');
        const ingresosChart = new Chart(ingresosCtx, {
            type: 'bar',
            data: {
                labels: ['Cantina', 'Kiosco', 'Parrilla', 'Congelados'],
                datasets: [{
                    label: 'Ingresos (en pesos)',
                    data: [5000, 3000, 7000, 2000], // Cambia estos valores dinámicamente desde tu backend
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Gráfica de rendimiento por sector
        const rendimientoCtx = document.getElementById('rendimientoPorSector').getContext('2d');
        const rendimientoChart = new Chart(rendimientoCtx, {
            type: 'pie',
            data: {
                labels: ['Cantina', 'Kiosco', 'Parrilla', 'Congelados'],
                datasets: [{
                    label: 'Rendimiento (%)',
                    data: [25, 15, 40, 20], // Cambia estos valores dinámicamente desde tu backend
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgba(75, 192, 192, 0.5)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true
            }
        });

        async function cargarUsuarios() {
    const response = await fetch('http://localhost:3000/admin/usuarios');
    const usuarios = await response.json();

    const tablaUsuarios = document.getElementById('tablaUsuarios');
    tablaUsuarios.innerHTML = usuarios.map(usuario => `
        <tr>
            <td>${usuario.nombre}</td>
            <td>${usuario.sector}</td>
            <td>${usuario.ultimo_ingreso || 'No registrado'}</td>
            <td>${usuario.ultimo_egreso || 'No registrado'}</td>
            <td>
                <button class="btn btn-warning btn-sm">Editar</button>
                <button class="btn btn-danger btn-sm">Eliminar</button>
            </td>
        </tr>
    `).join('');
}

cargarUsuarios();

async function cargarVentasGlobales() {
    const response = await fetch('http://localhost:3000/admin/ventas');
    const ventas = await response.json();

    const tablaVentas = document.getElementById('tablaVentasGlobales');
    tablaVentas.innerHTML = ventas.map(venta => `
        <tr>
            <td>${new Date(venta.fecha).toLocaleString()}</td>
            <td>${venta.producto}</td>
            <td>${venta.cantidad}</td>
            <td>${venta.unidad}</td>
            <td>${venta.sector}</td>
            <td>${venta.empleado}</td>
        </tr>
    `).join('');
}

cargarVentasGlobales();

async function actualizarGraficaIngresos() {
    const response = await fetch('http://localhost:3000/admin/ingresos-sector');
    const data = await response.json();

    const sectores = data.map(item => item.sector);
    const ingresos = data.map(item => item.ingresos);

    ingresosChart.data.labels = sectores;
    ingresosChart.data.datasets[0].data = ingresos;
    ingresosChart.update();
}

actualizarGraficaIngresos();

async function actualizarGraficaRendimiento() {
    const response = await fetch('http://localhost:3000/admin/rendimiento-sector');
    const data = await response.json();

    const sectores = data.map(item => item.sector);
    const rendimientos = data.map(item => item.total_ventas);

    rendimientoChart.data.labels = sectores;
    rendimientoChart.data.datasets[0].data = rendimientos;
    rendimientoChart.update();
}

actualizarGraficaRendimiento();

async function cargarProductos() {
    const response = await fetch('http://localhost:3000/admin/productos');
    const productos = await response.json();

    const tablaProductos = document.getElementById('tablaProductos');
    tablaProductos.innerHTML = productos.map(producto => `
        <tr>
            <td>${producto.nombre}</td>
            <td>${producto.sector}</td>
            <td>${producto.precio_compra}</td>
            <td>${producto.precio_venta}</td>
            <td>${new Date(producto.fecha_creacion).toLocaleString()}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="eliminarProducto(${producto.id})">Eliminar</button>
            </td>
        </tr>
    `).join('');
}

async function eliminarProducto(id) {
    const response = await fetch(`http://localhost:3000/admin/productos/${id}`, { method: 'DELETE' });
    const data = await response.json();
    if (response.ok) {
        alert(data.message);
        cargarProductos();
    } else {
        alert(data.error);
    }
}

cargarProductos();

async function eliminarUsuario(id) {
    const response = await fetch(`http://localhost:3000/admin/usuarios/${id}`, { method: 'DELETE' });
    const data = await response.json();
    if (response.ok) {
        alert(data.message);
        cargarUsuarios();
    } else {
        alert(data.error);
    }
}

async function editarUsuario(id) {
    const nombre = prompt('Nuevo nombre:');
    const clave = prompt('Nueva clave:');
    const sector = prompt('Nuevo sector:');
    const response = await fetch(`http://localhost:3000/admin/usuarios/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre, clave, sector })
    });

    const data = await response.json();
    if (response.ok) {
        alert(data.message);
        cargarUsuarios();
    } else {
        alert(data.error);
    }
}


document.addEventListener('DOMContentLoaded', () => {
    cargarUsuarios();
    cargarVentasGlobales();
    actualizarGraficaIngresos();
    actualizarGraficaRendimiento();
});


    </script>
</body>
</html>
